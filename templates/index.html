<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Записи на стрижку</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        form {
            background-color: #fff;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        input, select, button {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        button {
            grid-column: 1 / 3;
            background-color: #28a745;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #218838;
        }
        input[type="date"] {
            width: 100%;
            max-width: 160px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ccc;
        }
        th {
            background-color: #f7f7f7;
        }
        tr:hover {
            background-color: #f1f1f1;
        }
        .action-buttons button {
            margin-right: 5px;
        }
        /* Добавим стили для блока статистики */
        .stats-section {
            margin-top: 30px;
            padding: 15px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .stats-results {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Записи на стрижку</h1>

    <form id="recordForm">
        <input type="text" id="firstName" placeholder="Имя" required>
        <input type="text" id="lastName" placeholder="Фамилия" required>
        <select id="master" required>
            <option value="" disabled selected>Выберите мастера</option>
        </select>
        <select id="haircut" required>
            <option value="" disabled selected>Выберите стрижку</option>
        </select>
        <input type="date" id="date" required>
        <button type="submit">Добавить</button>
        <input type="hidden" id="recordId">
    </form>

    <table>
        <thead>
            <tr>
                <th><button id="sortFirstName">Имя</button></th>
                <th><button id="sortLastName">Фамилия</button></th>
                <th><button id="sortMaster">Мастер</button></th>
                <th>Стрижка</th>
                <th><button id="sortDate">Дата</button></th>
                <th><button id="sortPrice">Цена</button></th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody id="recordTable">
        </tbody>
    </table>

    <!-- Добавим блок для статистики -->
    <div class="stats-section">
        <h2>Статистика по ценам</h2>
        <button id="calculateStats">Рассчитать статистику по ценам</button>

        <div class="stats-results" id="statsResults"></div>
    </div>

    <script>
        $(document).ready(function() {
            // Заполнение мастеров и стрижек при загрузке страницы
            $.get('/data', function(data) {
                data.masters.male.forEach(function(master) {
                    $('#master').append(`<option value="${master}">${master}</option>`);
                });
                data.masters.female.forEach(function(master) {
                    $('#master').append(`<option value="${master}">${master}</option>`);
                });
            });

            // Изменение списка стрижек при выборе мастера
            $('#master').on('change', function() {
                $('#haircut').empty().append('<option value="" disabled selected>Выберите стрижку</option>');
                const selectedMaster = $(this).val();
                $.get('/data', function(data) {
                    const haircuts = selectedMaster === 'Иванов' || selectedMaster === 'Петров' ? data.haircuts.male : data.haircuts.female;
                    haircuts.forEach(haircut => {
                        $('#haircut').append(`<option value="${haircut.name}">${haircut.name} - ${haircut.price} руб.</option>`);
                    });
                });
            });

            // Форма для добавления/редактирования записей
            $('#recordForm').on('submit', function(event) {
                event.preventDefault();

                const id = $('#recordId').val();
                const url = id ? `/records/${id}` : '/records';
                const type = id ? 'PUT' : 'POST';
                const data = {
                    first_name: $('#firstName').val(),
                    last_name: $('#lastName').val(),
                    master: $('#master').val(),
                    haircut: $('#haircut').val(),
                    date: $('#date').val()
                };

                $.ajax({
                    type: type,
                    url: url,
                    data: JSON.stringify(data),
                    contentType: 'application/json',
                    success: function(record) {
                        if (id) {
                            const row = $(`#record-${id}`);
                            row.find('td:nth-child(1)').text(record.first_name);
                            row.find('td:nth-child(2)').text(record.last_name);
                            row.find('td:nth-child(3)').text(record.master);
                            row.find('td:nth-child(4)').text(record.haircut);
                            row.find('td:nth-child(5)').text(formatDate(record.date));
                            row.find('td:nth-child(6)').text(record.price);
                        } else {
                            $('#recordTable').append(`
                                <tr id="record-${record.id}">
                                    <td>${record.first_name}</td>
                                    <td>${record.last_name}</td>
                                    <td>${record.master}</td>
                                    <td>${record.haircut}</td>
                                    <td>${formatDate(record.date)}</td>
                                    <td>${record.price}</td>
                                    <td class="action-buttons">
                                        <button onclick="editRecord(${record.id})">Изменить</button>
                                        <button onclick="deleteRecord(${record.id})">Удалить</button>
                                    </td>
                                </tr>
                            `);
                        }
                        $('#recordForm')[0].reset();
                        $('#recordId').val('');
                        $('button[type="submit"]').text('Добавить');
                    },
                    error: function(xhr) {
                        alert(xhr.responseJSON.error);
                    }
                });
            });

            // Кнопки для сортировки
            $('#sortFirstName').on('click', function() {
                sortRecords('first_name');
            });

            $('#sortLastName').on('click', function() {
                sortRecords('last_name');
            });

            $('#sortMaster').on('click', function() {
                sortRecords('master');
            });

            $('#sortDate').on('click', function() {
                sortRecords('date');
            });

            $('#sortPrice').on('click', function() {
                sortRecords('price');
            });

            function sortRecords(field) {
                $.get(`/records/sort?field=${field}`, function(sortedRecords) {
                    $('#recordTable').empty();
                    sortedRecords.forEach(record => {
                        $('#recordTable').append(`
                            <tr id="record-${record.id}">
                                <td>${record.first_name}</td>
                                <td>${record.last_name}</td>
                                <td>${record.master}</td>
                                <td>${record.haircut}</td>
                                <td>${formatDate(record.date)}</td>
                                <td>${record.price}</td>
                                <td class="action-buttons">
                                    <button onclick="editRecord(${record.id})">Изменить</button>
                                    <button onclick="deleteRecord(${record.id})">Удалить</button>
                                </td>
                            </tr>
                        `);
                    });
                });
            }

            // Форматирование даты
            function formatDate(dateStr) {
                const date = new Date(dateStr);
                return date.toLocaleDateString('ru-RU', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }

            // Рассчет статистики по ценам
            $('#calculateStats').on('click', function() {
                $.get(`/records/stats?field=price`, function(stats) {
                    if (stats.error) {
                        $('#statsResults').html(`<p>Ошибка: ${stats.error}</p>`);
                    } else {
                        $('#statsResults').html(`
                            <p>Средняя цена: ${stats.average.toFixed(2)} руб.</p>
                            <p>Минимальная цена: ${stats.min} руб.</p>
                            <p>Максимальная цена: ${stats.max} руб.</p>
                        `);
                    }
                });
            });

            // Редактирование записи
            window.editRecord = function(id) {
                $.get(`/records/${id}`, function(record) {
                    $('#firstName').val(record.first_name);
                    $('#lastName').val(record.last_name);
                    $('#master').val(record.master).change();
                    $('#haircut').val(record.haircut);
                    $('#date').val(record.date);
                    $('#recordId').val(record.id);
                    $('button[type="submit"]').text('Изменить');
                });
            }

            // Удаление записи
            window.deleteRecord = function(id) {
                $.ajax({
                    type: 'DELETE',
                    url: `/records/${id}`,
                    success: function() {
                        $(`#record-${id}`).remove();
                    },
                    error: function(xhr) {
                        alert(xhr.responseJSON.error);
                    }
                });
            }
        });
    </script>
</body>
</html>